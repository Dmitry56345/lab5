<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width"
        />
        <title>Список пользователей</title>
        <link
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    </head>
    <body>
        <h2>Список пользователей</h2>
        <form action="/profile" method="post" enctype="multipart/form-data">
  <input type="file" name="avatar" />
</form>
        <table
            class="table table-condensed table-striped table-bordered"
        >
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Имя</th>
                    <th>возраст</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <script>
            // Получение всех пользователей
            function GetUsers() {
                $.ajax({
                    url: '/api/users',
                    type: 'GET',
                    contentType: 'application/json',
                    success: function (users) {
                        var rows = '';
                        $.each(users, function (
                            index,
                            user
                        ) {
                            // добавляем полученные элементы в таблицу
                            rows += row(user);
                        });
                        $('table tbody').append(rows);
                    },
                });
            }
            // Получение одного пользователя
            function GetUser(id) {
                $.ajax({
                    url: '/api/users/' + id,
                    type: 'GET',
                    contentType: 'application/json',
                    success: function (user) {
                        var form =
                            document.forms['userForm'];
                        form.elements['id'].value = user.id;
                        form.elements['name'].value =
                            user.name;
                        form.elements['age'].value =
                            user.age;
                    },
                });
            }
            // Добавление пользователя
            function CreateUser(userName, userAge) {
                $.ajax({
                    url: 'api/users',
                    contentType: 'application/json',
                    method: 'POST',
                    data: JSON.stringify({
                        name: userName,
                        age: userAge,
                    }),
                    success: function (user) {
                        reset();
                        $('table tbody').append(row(user));
                    },
                });
            }

            // Удаление пользователя
            function DeleteUser(id) {
                $.ajax({
                    url: 'api/users/' + id,
                    contentType: 'application/json',
                    method: 'DELETE',
                    success: function (user) {
                        console.log(user);
                        $(
                            "tr[data-rowid='" +
                                user.id +
                                "']"
                        ).remove();
                    },
                });
            }
            // создание строки для таблицы
            var row = function (user) {
                return (
                    "<tr data-rowid='" +
                    user.id +
                    "'><td>" +
                    user.id +
                    '</td>' +
                    '<td>' +
                    user.name +
                    '</td> <td>' +
                    user.age +
                    '</td>' +
                    "<td><a class='editLink' data-id='" +
                    user.id +
                    "'>Изменить</a> | " +
                    "<a class='removeLink' data-id='" +
                    user.id +
                    "'>Удалить</a></td></tr>"
                );
            };
            // сброс значений формы
            $('#reset').click(function (e) {
                e.preventDefault();
                reset();
            });

            // отправка формы
            $('form').submit(function (e) {
                e.preventDefault();
                var id = this.elements['id'].value;
                var name = this.elements['name'].value;
                var age = this.elements['age'].value;
                if (id == 0) CreateUser(name, age);
                else EditUser(id, name, age);
            });

            // нажимаем на ссылку Удалить
            $('body').on(
                'click',
                '.removeLink',
                function () {
                    var id = $(this).data('id');
                    DeleteUser(id);
                }
            );

            // загрузка пользователей
            GetUsers();
        </script>
    </body>
</html>
